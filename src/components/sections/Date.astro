---
import Section from "./Section.astro";
import peter from "@/assets/video/peter-paker-dancing.webm";
import peterImg from "@/assets/peter-paker-dacing.png";
import dialog from "@/assets/dialog/dialogo-pensamiento.png";
import { Image } from "astro:assets";

---

<Section className="relative h-full font-chicle justify-between px-0 pt-[5vh]">
    <!-- Fecha -->
    <div>
        <h2 class="text-6xl font-bold mt-6">
            3 <span class="text-4xl">de</span> Noviembre
        </h2>
    </div>
    <!-- Dialogo de pensamiento -->
     
    <div class="relative">
        <Image src={dialog} alt="Dialogo de pensamiento" class="w-4/5 mx-auto rotate-12 translate-y-3 -translate-x-3" />
        
        <p class="
        absolute w-2/5 max-h-25 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -rotate-2
        text-black  font-anime-ace italic text-base  text-center overflow-hidden">
        <!-- Texto antes del evento -->
            <span id="dialog-before" class="hidden">
                Solo falta<i>n</i> <span class="days font-bold text-2xl">2</span> día<i>s</i> para la gran fiesta. 
            </span>
        <!-- Texto el día del evento -->
            <span id="dialog-today" class="hidden">
                <span class="font-bold text-2xl">HOY</span> es el <br>
                <span class="font-bold text-xl">gran día</span>
            </span>
        <!-- Texto después del evento -->
            <span id="dialog-after" class="hidden">
                Ya pas<i>ar</i>o<i>n</i> <span class="days font-bold text-2xl">2</span> día<i>s</i> de la gran fiesta. 
            </span>
        </p>
    </div>
    <!-- Horario -->
    <div class="flex-2 text-start flex flex-col text-5xl w-5/12 self-end font-komika-title">
        <p class="">
            <span class="pl-4 text-3xl">de</span> <br>
            18:00Hs
        </p>
        <p class="">
            <span class="pl-4 text-3xl">a</span> <br>
            21:00Hs
        </p>
    </div>
    <div class="absolute left-0 -bottom-3 h-1/2 w-7/12 overflow-hidden">
        <!-- Video para navegadores compatibles con WebM -->
        <video 
            id="peter-video" 
            autoplay 
            loop 
            muted 
            playsinline 
            class="h-full object-cover mx-auto my-4 hidden"
        >
            <source src={peter} type="video/webm" />
            Your browser does not support the video tag.
        </video>
        
        <!-- Imagen de respaldo para Safari y navegadores incompatibles -->
        <Image 
            id="peter-image" 
            src={peterImg} 
            alt="Peter Parker dancing" 
            class="h-full object-cover mx-auto my-4 hidden"
        />
    </div>
</Section>

<style>
    .font-komika-title {
        -webkit-text-stroke: 1px black;
        text-stroke: 1px black;
        text-shadow: 2px 2px 1px black;
    }
</style>

<script>
    const S = 1000, M = S * 60, H = M * 60, D = H * 24;
    const eventDate = new Date("2025-11-03T18:00:00-03:00").getTime();

    const $days = document.querySelectorAll(".days") as NodeListOf<HTMLSpanElement>;
    
    // Elementos del diálogo
    const $dialogBefore = document.getElementById("dialog-before");
    const $dialogToday = document.getElementById("dialog-today");
    const $dialogAfter = document.getElementById("dialog-after");

    const updateDialogDisplay = () => {
        const now = Date.now();
        const diff = eventDate - now;

        const days = Math.floor(diff / D);

        if (Math.abs(days) == 1) {
                document.querySelectorAll("i").forEach( el => {
                    el.classList.add("hidden");
                });
        }
        
        
        if (days > 0) {
            // Antes del día del evento
            if ($dialogBefore) $dialogBefore.classList.remove("hidden");
        } else if (days === 0) {
            // El día del evento
            if ($dialogToday) $dialogToday.classList.remove("hidden");
        } else {
            // Después del evento
            if ($dialogAfter) $dialogAfter.classList.remove("hidden");
        }
    };

    const updateTimer = () => {
        const now = Date.now();
        const diff = eventDate - now;
        let days = Math.floor(diff / D);

        if ($days !== null) $days.forEach(el => el.innerText = Math.abs(days).toString());

        // Actualizar la visualización del diálogo
        updateDialogDisplay();
    };

    // Detectar si es Safari o un navegador que no soporta WebM con canal alpha
    const isSafariOrUnsupported = () => {
        const userAgent = navigator.userAgent.toLowerCase();
        
        // Detectar Safari (incluye Safari en iOS y macOS)
        const isSafari = /safari/.test(userAgent) && !/chrome/.test(userAgent) && !/chromium/.test(userAgent);
        
        // Detectar otros navegadores que pueden tener problemas con WebM
        const isIOS = /ipad|iphone|ipod/.test(userAgent);
        const isOldEdge = /edge/.test(userAgent);
        
        return isSafari || isIOS || isOldEdge;
    };

    // Mostrar video o imagen según el soporte del navegador
    const initializePeterMedia = () => {
        const video = document.getElementById("peter-video");
        const image = document.getElementById("peter-image");
        
        if (isSafariOrUnsupported()) {
            // Usar imagen para Safari y navegadores incompatibles
            if (image) {
                image.classList.remove("hidden");
            }
            if (video) {
                video.classList.add("hidden");
            }
        } else {
            // Usar video para navegadores compatibles
            if (video) {
                video.classList.remove("hidden");
            }
            if (image) {
                image.classList.add("hidden");
            }
        }
    };

    // Inicializar la visualización del diálogo
    updateDialogDisplay();
    updateTimer();
    setInterval(updateTimer, 2000);
    
    // Inicializar el medio apropiado cuando la página esté lista
    document.addEventListener("DOMContentLoaded", initializePeterMedia);
    
    // También ejecutar inmediatamente en caso de que DOMContentLoaded ya haya pasado
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializePeterMedia);
    } else {
        initializePeterMedia();
    }
</script>
